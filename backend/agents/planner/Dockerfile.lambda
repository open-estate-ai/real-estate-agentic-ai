ARG PYTHON_VERSION=3.12
FROM public.ecr.aws/lambda/python:${PYTHON_VERSION}

# Install system dependencies
RUN microdnf install -y postgresql-devel gcc tar gzip && \
    microdnf clean all

# Copy shared module to expected location for uv path dependency resolution
COPY shared ${LAMBDA_TASK_ROOT}/../../shared/

# Install shared module first
RUN cd ${LAMBDA_TASK_ROOT}/../../shared && pip install --no-cache-dir .

# Install dependencies from pyproject.toml (excluding real-estate-shared which is already installed)
RUN pip install --no-cache-dir \
    fastapi>=0.115.0 \
    hypercorn>=0.17.0 \
    sqlalchemy>=2.0.0 \
    psycopg2-binary>=2.9.0 \
    pydantic>=2.0.0 \
    pydantic-settings>=2.0.0 \
    boto3>=1.35.0 \
    litellm>=1.50.0

# Copy application code
COPY agents/planner/src/ ${LAMBDA_TASK_ROOT}/src/

# Set the Lambda handler
CMD ["src.lambda_handler.lambda_handler"]
